# ä¸ºä»€ä¹ˆé€šå¸¸åœ¨å‘é€æ•°æ®åŸ‹ç‚¹è¯·æ±‚çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯1*1åƒç´ çš„é€æ˜GIFï¼Ÿ
1. èƒ½å¤Ÿå®Œæˆæ•´ä¸ªhttpè¯·æ±‚+å“åº”ï¼Œå°½ç®¡ä¸éœ€è¦å“åº”å†…å®¹
2. è§¦å‘getè¯·æ±‚åï¼Œä¸éœ€è¦è·å–å’Œå¤„ç†æ•°æ®ï¼ŒæœåŠ¡å™¨ä¹Ÿä¸éœ€è¦å‘é€æ•°æ®
3. è·¨åŸŸå‹å¥½
4. æ‰§è¡Œè¿‡ç¨‹æ— é˜»å¡
5. ç›¸æ¯”XMLHttpRequestå¯¹è±¡å‘é€getè¯·æ±‚ï¼Œæ€§èƒ½ä¸Šæ›´å¥½
6. GIFçš„æœ€ä½åˆæ³•ä½“ç§¯æœ€å°ï¼Œåˆæ³•çš„GIFåªéœ€è¦43å­—èŠ‚
https://juejin.cn/post/7172072612430872584
https://juejin.cn/post/7173596154297810957

å‰ç«¯ç›‘æ§å°±æ˜¯ä¸€ä¸ªå¾ˆæœ‰äº®ç‚¹çš„é¡¹ç›®ï¼Œå„ä¸ªå¤§å‚éƒ½æœ‰è‡ªå·±çš„å†…éƒ¨å®ç°ï¼Œæ²¡æœ‰ç›‘æ§çš„é¡¹ç›®å¥½æ¯”æ˜¯åœ¨è£¸å¥”
æ–‡ç« åˆ†æˆä»¥ä¸‹å…­éƒ¨åˆ†æ¥ä»‹ç»ï¼š


è‡ªç ”ç›‘æ§å¹³å°è§£å†³äº†å“ªäº›ç—›ç‚¹ï¼Œå®ç°äº†ä»€ä¹ˆäº®ç‚¹åŠŸèƒ½ï¼Ÿ


ç›¸æ¯”sentryç­‰ç›‘æ§æ–¹æ¡ˆï¼Œè‡ªç ”ç›‘æ§çš„ä¼˜åŠ¿æœ‰å“ªäº›ï¼Ÿ


å‰ç«¯ç›‘æ§çš„è®¾è®¡æ–¹æ¡ˆã€ç›‘æ§çš„ç›®çš„


æ•°æ®çš„é‡‡é›†æ–¹å¼ï¼šé”™è¯¯ä¿¡æ¯ã€æ€§èƒ½æ•°æ®ã€ç”¨æˆ·è¡Œä¸ºã€åŠ è½½èµ„æºã€ä¸ªæ€§åŒ–æŒ‡æ ‡ç­‰


è®¾è®¡å¼€å‘ä¸€ä¸ªå®Œæ•´çš„ç›‘æ§SDK


ç›‘æ§åå°é”™è¯¯è¿˜åŸæ¼”ç¤ºç¤ºä¾‹


ç—›ç‚¹
æŸâ¼€å¤©ç”¨æˆ·ï¼šxxå•†å“æ— æ³•ä¸‹å•ï¼
â¼œâ¼€å¤©è¿è¥ï¼šxxå¹¿å‘Šåœ¨æ‰‹æœºç«¯æ‰“å¼€ä¸äº†ï¼
å¤§å®¶åé¦ˆçš„bugï¼Œæ€ä¹ˆéƒ½å¤ç°ä¸å‡ºæ¥ï¼Œå°´å°¬çš„è¦æ­»ï¼ğŸ˜¢
å¦‚ä½•è®°å½•é¡¹ç›®çš„é”™è¯¯ï¼Œå¹¶å°†é”™è¯¯è¿˜åŸå‡ºæ¥ï¼Œè¿™æ˜¯ç›‘æ§å¹³å°è¦è§£å†³çš„ç—›ç‚¹ä¹‹ä¸€
é”™è¯¯è¿˜åŸ
web-see ç›‘æ§æä¾›ä¸‰ç§é”™è¯¯è¿˜åŸæ–¹å¼ï¼šå®šä½æºç ã€æ’­æ”¾å½•å±ã€è®°å½•ç”¨æˆ·è¡Œä¸º

å‰ç«¯å½•å±ç¡®å®æ˜¯ä»¶å¾ˆé…·çš„äº‹æƒ…ï¼Œä½†æ˜¯ä¸èƒ½èµ°æç«¯ï¼Œå¦‚æœæŠŠç”¨æˆ·çš„æ‰€æœ‰æ“ä½œéƒ½å½•åˆ¶ä¸‹æ¥ï¼Œæ˜¯æ²¡æœ‰æ„ä¹‰çš„
æˆ‘ä»¬æ›´å…³æ³¨çš„æ˜¯ï¼Œé¡µé¢æŠ¥é”™çš„æ—¶å€™ç”¨æˆ·åšäº†å“ªäº›æ“ä½œï¼Œæ‰€ä»¥ç›‘æ§å¹³å°åªæŠŠæŠ¥é”™å‰10sçš„è§†é¢‘ä¿å­˜ä¸‹æ¥ï¼ˆå•æ¬¡å½•å±æ—¶é•¿ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼‰
è®°å½•ç”¨æˆ·è¡Œä¸º
é€šè¿‡ å®šä½æºç  + æ’­æ”¾å½•å± è¿™å¥—ç»„åˆï¼Œè¿˜åŸé”™è¯¯åº”è¯¥å¤Ÿç”¨äº†ï¼ŒåŒæ—¶ç›‘æ§å¹³å°ä¹Ÿæä¾›äº† è®°å½•ç”¨æˆ·è¡Œä¸º è¿™ç§æ–¹å¼
å‡å¦‚ç”¨æˆ·åšäº†å¾ˆå¤šæ“ä½œï¼Œæ“ä½œçš„é—´éš”è¶…è¿‡äº†å•æ¬¡å½•å±æ—¶é•¿ï¼Œå½•åˆ¶çš„è§†é¢‘å¯èƒ½æ˜¯ä¸å®Œæ•´çš„ï¼Œæ­¤æ—¶å¯ä»¥å€ŸåŠ©ç”¨æˆ·è¡Œä¸ºæ¥åˆ†æç”¨æˆ·çš„æ“ä½œï¼Œå¸®åŠ©å¤ç°bug

è‡ªç ”ç›‘æ§çš„ä¼˜åŠ¿
ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨sentryç§æœ‰åŒ–éƒ¨ç½²ï¼Œè€Œé€‰æ‹©è‡ªç ”å‰ç«¯ç›‘æ§ï¼Ÿ
è¿™æ˜¯ä¼˜å…ˆè¦æ€è€ƒçš„é—®é¢˜ï¼Œsentryä½œä¸ºå‰ç«¯ç›‘æ§çš„è¡Œä¸šæ ‡æ†ï¼Œæœ‰å¾ˆå¤šå¯ä»¥å€Ÿé‰´çš„åœ°æ–¹
ç›¸æ¯”sentryï¼Œè‡ªç ”ç›‘æ§å¹³å°çš„ä¼˜åŠ¿åœ¨äºï¼š
1ã€å¯ä»¥å°†å…¬å¸çš„SDKç»Ÿä¸€æˆä¸€ä¸ªï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šç›‘æ§SDKã€åŸ‹ç‚¹SDKã€å½•å±SDKã€å¹¿å‘ŠSDKç­‰
2ã€æä¾›äº†æ›´å¤šçš„é”™è¯¯è¿˜åŸæ–¹å¼ï¼ŒåŒæ—¶é”™è¯¯ä¿¡æ¯å¯ä»¥å’ŒåŸ‹ç‚¹ä¿¡æ¯è”åŠ¨ï¼Œä¾¿å¯æ‹¿åˆ°æ›´ç»†è‡´çš„ç”¨æˆ·è¡Œä¸ºæ ˆï¼Œæ›´å¿«çš„æ’æŸ¥çº¿ä¸Šé”™è¯¯
3ã€ç›‘æ§è‡ªå®šä¹‰çš„ä¸ªæ€§åŒ–æŒ‡æ ‡ï¼šå¦‚ long taskã€memoryé¡µé¢å†…å­˜ã€é¦–å±åŠ è½½æ—¶é—´ç­‰ã€‚è¿‡å¤šçš„é•¿ä»»åŠ¡ä¼šé€ æˆé¡µé¢ä¸¢å¸§ã€å¡é¡¿ï¼›è¿‡å¤§çš„å†…å­˜å¯èƒ½ä¼šé€ æˆä½ç«¯æœºå™¨çš„å¡æ­»ã€å´©æºƒ
4ã€ç»Ÿè®¡èµ„æºç¼“å­˜ç‡ï¼Œæ¥åˆ¤æ–­é¡¹ç›®çš„ç¼“å­˜ç­–ç•¥æ˜¯å¦åˆç†ï¼Œæå‡ç¼“å­˜ç‡å¯ä»¥å‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼Œä¹Ÿå¯ä»¥æå‡é¡µé¢çš„æ‰“å¼€é€Ÿåº¦
5ã€æä¾›äº†Â é‡‡æ ·å¯¹æ¯”+ è½®è¯¢ä¿®æ­£æœºåˆ¶Â çš„ç™½å±æ£€æµ‹æ–¹æ¡ˆï¼Œç”¨äºæ£€æµ‹é¡µé¢æ˜¯å¦ä¸€ç›´å¤„äºç™½å±çŠ¶æ€ï¼Œè®©å¼€å‘è€…çŸ¥é“é¡µé¢ä»€ä¹ˆæ—¶å€™ç™½äº†ï¼Œå…·ä½“å®ç°è§ å‰ç«¯ç™½å±çš„æ£€æµ‹æ–¹æ¡ˆï¼Œè§£å†³ä½ çš„çº¿ä¸Šä¹‹å¿§


ä¸€ä¸ªå®Œæ•´çš„å‰ç«¯ç›‘æ§å¹³å°åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼šæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥ã€æ•°æ®åˆ†æå’Œå­˜å‚¨ã€æ•°æ®å±•ç¤º



# å¼‚å¸¸åˆ†æ
æŒ‰ç…§ 5W1H æ³•åˆ™æ¥åˆ†æå‰ç«¯å¼‚å¸¸ï¼Œéœ€è¦çŸ¥é“ä»¥ä¸‹ä¿¡æ¯

Whatï¼Œå‘â½£äº†ä»€ä¹ˆé”™è¯¯ï¼šJSé”™è¯¯ã€å¼‚æ­¥é”™è¯¯ã€èµ„æºåŠ è½½ã€æ¥å£é”™è¯¯ç­‰
Whenï¼Œå‡ºç°çš„æ—¶é—´æ®µï¼Œå¦‚æ—¶é—´æˆ³
Whoï¼Œå½±å“äº†å¤šå°‘ç”¨æˆ·ï¼ŒåŒ…æ‹¬æŠ¥é”™äº‹ä»¶æ•°ã€IP
Whereï¼Œå‡ºç°çš„é¡µé¢æ˜¯å“ªäº›ï¼ŒåŒ…æ‹¬é¡µé¢ã€å¯¹åº”çš„è®¾å¤‡ä¿¡æ¯
Whyï¼Œé”™è¯¯çš„åŸå› æ˜¯ä¸ºä»€ä¹ˆï¼ŒåŒ…æ‹¬é”™è¯¯å †æ ˆã€â¾åˆ—ã€SourceMapã€å¼‚å¸¸å½•å±
Howï¼Œå¦‚ä½•å®šä½è¿˜åŸé—®é¢˜ï¼Œå¦‚ä½•å¼‚å¸¸æŠ¥è­¦ï¼Œé¿å…ç±»ä¼¼çš„é”™è¯¯å‘ç”Ÿ

ä½œè€…ï¼šæµ·é˜”_å¤©ç©º
é“¾æ¥ï¼šhttps://juejin.cn/post/7172072612430872584
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

# é”™è¯¯æ•°æ®é‡‡é›†
é”™è¯¯ä¿¡æ¯æ˜¯æœ€åŸºç¡€ä¹Ÿæ˜¯æœ€é‡è¦çš„æ•°æ®ï¼Œé”™è¯¯ä¿¡æ¯ä¸»è¦åˆ†ä¸ºä¸‹é¢å‡ ç±»ï¼š

JS ä»£ç è¿è¡Œé”™è¯¯ã€è¯­æ³•é”™è¯¯ç­‰
å¼‚æ­¥é”™è¯¯ç­‰
é™æ€èµ„æºåŠ è½½é”™è¯¯
æ¥å£è¯·æ±‚æŠ¥é”™


# é”™è¯¯æ•è·æ–¹å¼
1ï¼‰try/catch

åªèƒ½æ•è·ä»£ç å¸¸è§„çš„è¿è¡Œé”™è¯¯ï¼Œè¯­æ³•é”™è¯¯å’Œå¼‚æ­¥é”™è¯¯ä¸èƒ½æ•è·åˆ°

```js
// ç¤ºä¾‹1ï¼šå¸¸è§„è¿è¡Œæ—¶é”™è¯¯ï¼Œå¯ä»¥æ•è· âœ…
 try {
   let a = undefined;
   if (a.length) {
     console.log('111');
   }
 } catch (e) {
   console.log('æ•è·åˆ°å¼‚å¸¸ï¼š', e);
}

// ç¤ºä¾‹2ï¼šè¯­æ³•é”™è¯¯ï¼Œä¸èƒ½æ•è· âŒ
try {
  const notdefined,
} catch(e) {
  console.log('æ•è·ä¸åˆ°å¼‚å¸¸ï¼š', 'Uncaught SyntaxError');
}

// ç¤ºä¾‹3ï¼šå¼‚æ­¥é”™è¯¯ï¼Œä¸èƒ½æ•è· âŒ
try {
  setTimeout(() => {
    console.log(notdefined);
  }, 0)
} catch(e) {
  console.log('æ•è·ä¸åˆ°å¼‚å¸¸ï¼š', 'Uncaught ReferenceError');
}
```
# vue

Vueé¡¹ç›®ä¸­ï¼Œwindow.onerror å’Œ error äº‹ä»¶ä¸èƒ½æ•è·åˆ°å¸¸è§„çš„ä»£ç é”™è¯¯


vue é€šè¿‡ Vue.config.errorHander æ¥æ•è·å¼‚å¸¸ï¼š


# react
ä» react16 å¼€å§‹ï¼Œå®˜æ–¹æä¾›äº† ErrorBoundary é”™è¯¯è¾¹ç•Œçš„åŠŸèƒ½ï¼Œè¢«è¯¥ç»„ä»¶åŒ…è£¹çš„å­ç»„ä»¶ï¼Œrender å‡½æ•°æŠ¥é”™æ—¶ä¼šè§¦å‘ç¦»å½“å‰ç»„ä»¶æœ€è¿‘çˆ¶ç»„ä»¶çš„ErrorBoundary
ç”Ÿäº§ç¯å¢ƒï¼Œä¸€æ—¦è¢« ErrorBoundary æ•è·çš„é”™è¯¯ï¼Œä¹Ÿä¸ä¼šè§¦å‘å…¨å±€çš„ window.onerror å’Œ error äº‹ä»¶

åŒvueé¡¹ç›®çš„å¤„ç†ç±»ä¼¼ï¼Œreacté¡¹ç›®ä¸­ï¼Œå¯ä»¥åœ¨ componentDidCatch ä¸­å°†æ•è·çš„é”™è¯¯ä¸ŠæŠ¥

# è·¨åŸŸé—®é¢˜
è·¨åŸŸé—®é¢˜
å¦‚æœå½“å‰é¡µé¢ä¸­ï¼Œå¼•å…¥äº†å…¶ä»–åŸŸåçš„JSèµ„æºï¼Œå¦‚æœèµ„æºå‡ºç°é”™è¯¯ï¼Œerror äº‹ä»¶åªä¼šç›‘æµ‹åˆ°ä¸€ä¸ªÂ script error çš„å¼‚å¸¸ã€‚
ç¤ºä¾‹ï¼š
window.addEventListener("error", error => {
  console.log("æ•è·åˆ°å¼‚å¸¸ï¼š", error);
}, true );

// å½“å‰é¡µé¢åŠ è½½å…¶ä»–åŸŸçš„èµ„æºï¼Œå¦‚https://www.test.com/index.js
<script src="https://www.test.com/index.js"></script>

// åŠ è½½çš„https://www.test.com/index.jsçš„ä»£ç 
function fn() {
  JSON.parse("");
}
fn();
å¤åˆ¶ä»£ç 
æŠ¥é”™ä¿¡æ¯ï¼š

åªèƒ½æ•è·åˆ° script error çš„åŸå› ï¼š
æ˜¯ç”±äºæµè§ˆå™¨åŸºäºå®‰å…¨è€ƒè™‘ï¼Œæ•…æ„éšè—äº†å…¶å®ƒåŸŸJSæ–‡ä»¶æŠ›å‡ºçš„å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆé¿å…æ•æ„Ÿä¿¡æ¯æ— æ„ä¸­è¢«ç¬¬ä¸‰æ–¹(ä¸å—æ§åˆ¶çš„)è„šæœ¬æ•è·åˆ°ï¼Œå› æ­¤ï¼Œæµè§ˆå™¨åªå…è®¸åŒåŸŸä¸‹çš„è„šæœ¬æ•è·å…·ä½“çš„é”™è¯¯ä¿¡æ¯
è§£å†³æ–¹æ³•ï¼š
å‰ç«¯scriptåŠ crossoriginï¼Œåç«¯é…ç½® Access-Control-Allow-Origin
<script src="https://www.test.com/index.js" crossorigin></script>
å¤åˆ¶ä»£ç 
æ·»åŠ  crossorigin åå¯ä»¥æ•è·åˆ°å®Œæ•´çš„æŠ¥é”™ä¿¡æ¯ï¼š

å¦‚æœä¸èƒ½ä¿®æ”¹æœåŠ¡ç«¯çš„è¯·æ±‚å¤´ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡ä½¿ç”¨ try/catch ç»•è¿‡ï¼Œå°†é”™è¯¯æŠ›å‡º

# æ¥å£é”™è¯¯
æ¥å£é”™è¯¯
æ¥å£ç›‘æ§çš„å®ç°åŸç†ï¼šé’ˆå¯¹æµè§ˆå™¨å†…ç½®çš„ XMLHttpRequestã€fetch å¯¹è±¡ï¼Œåˆ©ç”¨ AOP åˆ‡ç‰‡ç¼–ç¨‹é‡å†™è¯¥æ–¹æ³•ï¼Œå®ç°å¯¹è¯·æ±‚çš„æ¥å£æ‹¦æˆªï¼Œä»è€Œè·å–æ¥å£æŠ¥é”™çš„æƒ…å†µå¹¶ä¸ŠæŠ¥

```js
function xhrReplace() {
  if (!("XMLHttpRequest" in window)) {
    return;
  }
  const originalXhrProto = XMLHttpRequest.prototype;
  // é‡å†™XMLHttpRequest åŸå‹ä¸Šçš„openæ–¹æ³•
  replaceAop(originalXhrProto, "open", originalOpen => {
    return function(...args) {
      // è·å–è¯·æ±‚çš„ä¿¡æ¯
      this._xhr = {
        method: typeof args[0] === "string" ? args[0].toUpperCase() : args[0],
        url: args[1],
        startTime: new Date().getTime(),
        type: "xhr"
      };
      // æ‰§è¡ŒåŸå§‹çš„openæ–¹æ³•
      originalOpen.apply(this, args);
    };
  });
  // é‡å†™XMLHttpRequest åŸå‹ä¸Šçš„sendæ–¹æ³•
  replaceAop(originalXhrProto, "send", originalSend => {
    return function(...args) {
      // å½“è¯·æ±‚ç»“æŸæ—¶è§¦å‘ï¼Œæ— è®ºè¯·æ±‚æˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½ä¼šè§¦å‘
      this.addEventListener("loadend", () => {
        const { responseType, response, status } = this;
        const endTime = new Date().getTime();
        this._xhr.reqData = args[0];
        this._xhr.status = status;
        if (["", "json", "text"].indexOf(responseType) !== -1) {
          this._xhr.responseText =
            typeof response === "object" ? JSON.stringify(response) : response;
        }
        // è·å–æ¥å£çš„è¯·æ±‚æ—¶é•¿
        this._xhr.elapsedTime = endTime - this._xhr.startTime;

        // ä¸ŠæŠ¥xhræ¥å£æ•°æ®
        reportData(this._xhr);
      });
      // æ‰§è¡ŒåŸå§‹çš„sendæ–¹æ³•
      originalSend.apply(this, args);
    };
  });
}

/**
 * é‡å†™æŒ‡å®šçš„æ–¹æ³•
 * @param { object } source é‡å†™çš„å¯¹è±¡
 * @param { string } name é‡å†™çš„å±æ€§
 * @param { function } fn æ‹¦æˆªçš„å‡½æ•°
 */
function replaceAop(source, name, fn) {
  if (source === undefined) return;
  if (name in source) {
    var original = source[name];
    var wrapped = fn(original);
    if (typeof wrapped === "function") {
      source[name] = wrapped;
    }
  }
}
```

# æ€§èƒ½æ•°æ®é‡‡é›†
åŒ…æ‹¬dnsæŸ¥è¯¢ã€å»ºç«‹tcpè¿æ¥ã€å‘é€httpè¯·æ±‚ã€è¿”å›htmlæ–‡æ¡£ã€htmlæ–‡æ¡£è§£æç­‰é˜¶æ®µ

æœ€åˆï¼Œå¯ä»¥é€šè¿‡ window.performance.timing æ¥è·å–åŠ è½½è¿‡ç¨‹æ¨¡å‹ä¸­å„ä¸ªé˜¶æ®µçš„è€—æ—¶æ•°æ®


```js
// window.performance.timing å„å­—æ®µè¯´æ˜
{
    navigationStart,  // åŒä¸€ä¸ªæµè§ˆå™¨ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸Šä¸€ä¸ªæ–‡æ¡£ç»“æŸæ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ–‡æ¡£ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    unloadEventStart,  // ä¸Šä¸€ä¸ªæ–‡æ¡£ unload äº‹ä»¶è§¦å‘æ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ–‡æ¡£ï¼Œä¸º 0ã€‚
    unloadEventEnd, // ä¸Šä¸€ä¸ªæ–‡æ¡£ unload äº‹ä»¶ç»“æŸæ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ–‡æ¡£ï¼Œä¸º 0ã€‚
    redirectStart, // è¡¨ç¤ºç¬¬ä¸€ä¸ª http é‡å®šå‘å¼€å§‹æ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰é‡å®šå‘æˆ–è€…æœ‰ä¸€ä¸ªéåŒæºçš„é‡å®šå‘ï¼Œä¸º 0ã€‚
    redirectEnd, // è¡¨ç¤ºæœ€åä¸€ä¸ª http é‡å®šå‘ç»“æŸæ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰é‡å®šå‘æˆ–è€…æœ‰ä¸€ä¸ªéåŒæºçš„é‡å®šå‘ï¼Œä¸º 0ã€‚
    fetchStart, // è¡¨ç¤ºæµè§ˆå™¨å‡†å¤‡å¥½ä½¿ç”¨ http è¯·æ±‚æ¥è·å–æ–‡æ¡£çš„æ—¶é—´æˆ³ã€‚è¿™ä¸ªæ—¶é—´ç‚¹ä¼šåœ¨æ£€æŸ¥ä»»ä½•ç¼“å­˜ä¹‹å‰ã€‚
    domainLookupStart, // åŸŸåæŸ¥è¯¢å¼€å§‹çš„æ—¶é—´æˆ³ã€‚å¦‚æœä½¿ç”¨äº†æŒä¹…è¿æ¥æˆ–è€…æœ¬åœ°æœ‰ç¼“å­˜ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    domainLookupEnd, // åŸŸåæŸ¥è¯¢ç»“æŸçš„æ—¶é—´æˆ³ã€‚å¦‚æœä½¿ç”¨äº†æŒä¹…è¿æ¥æˆ–è€…æœ¬åœ°æœ‰ç¼“å­˜ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    connectStart, // http è¯·æ±‚å‘æœåŠ¡å™¨å‘é€è¿æ¥è¯·æ±‚æ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœä½¿ç”¨äº†æŒä¹…è¿æ¥ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    connectEnd, // æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹å‰å»ºç«‹è¿æ¥çš„æ—¶é—´æˆ³ï¼Œæ‰€æœ‰æ¡æ‰‹å’Œè®¤è¯è¿‡ç¨‹å…¨éƒ¨ç»“æŸã€‚å¦‚æœä½¿ç”¨äº†æŒä¹…è¿æ¥ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    secureConnectionStart, // æµè§ˆå™¨ä¸æœåŠ¡å™¨å¼€å§‹å®‰å…¨é“¾æ¥çš„æ¡æ‰‹æ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœå½“å‰ç½‘é¡µä¸è¦æ±‚å®‰å…¨è¿æ¥ï¼Œè¿”å› 0ã€‚
    requestStart, // æµè§ˆå™¨å‘æœåŠ¡å™¨å‘èµ· http è¯·æ±‚(æˆ–è€…è¯»å–æœ¬åœ°ç¼“å­˜)æ—¶çš„æ—¶é—´æˆ³ï¼Œå³è·å– html æ–‡æ¡£ã€‚
    responseStart, // æµè§ˆå™¨ä»æœåŠ¡å™¨æ¥æ”¶åˆ°ç¬¬ä¸€ä¸ªå­—èŠ‚æ—¶çš„æ—¶é—´æˆ³ã€‚
    responseEnd, // æµè§ˆå™¨ä»æœåŠ¡å™¨æ¥å—åˆ°æœ€åä¸€ä¸ªå­—èŠ‚æ—¶çš„æ—¶é—´æˆ³ã€‚
    domLoading, // dom ç»“æ„å¼€å§‹è§£æçš„æ—¶é—´æˆ³ï¼Œdocument.readyState çš„å€¼ä¸º loadingã€‚
    domInteractive, // dom ç»“æ„è§£æç»“æŸï¼Œå¼€å§‹åŠ è½½å†…åµŒèµ„æºçš„æ—¶é—´æˆ³ï¼Œdocument.readyState çš„çŠ¶æ€ä¸º interactiveã€‚
    domContentLoadedEventStart, // DOMContentLoaded äº‹ä»¶è§¦å‘æ—¶çš„æ—¶é—´æˆ³ï¼Œæ‰€æœ‰éœ€è¦æ‰§è¡Œçš„è„šæœ¬æ‰§è¡Œå®Œæ¯•ã€‚
    domContentLoadedEventEnd,  // DOMContentLoaded äº‹ä»¶ç»“æŸæ—¶çš„æ—¶é—´æˆ³
    domComplete, // dom æ–‡æ¡£å®Œæˆè§£æçš„æ—¶é—´æˆ³ï¼Œ document.readyState çš„å€¼ä¸º completeã€‚
    loadEventStart, // load äº‹ä»¶è§¦å‘çš„æ—¶é—´ã€‚
    loadEventEnd // load æ—¶é—´ç»“æŸæ—¶çš„æ—¶é—´ã€‚
}
```

åæ¥ **window.performance.timing è¢«åºŸå¼ƒ**ï¼Œé€šè¿‡ `PerformanceObserver` æ¥è·å–ã€‚æ—§çš„ apiï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ª UNIX ç±»å‹çš„ç»å¯¹æ—¶é—´ï¼Œå’Œç”¨æˆ·çš„ç³»ç»Ÿæ—¶é—´ç›¸å…³ï¼Œåˆ†æçš„æ—¶å€™éœ€è¦å†æ¬¡è®¡ç®—ã€‚è€Œæ–°çš„ apiï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªç›¸å¯¹æ—¶é—´ï¼Œå¯ä»¥ç›´æ¥ç”¨æ¥åˆ†æ
ç°åœ¨ chrome å¼€å‘å›¢é˜Ÿæä¾›äº† web-vitals åº“ï¼Œæ–¹ä¾¿æ¥è®¡ç®—å„æ€§èƒ½æ•°æ®ï¼ˆæ³¨æ„ï¼šweb-vitals ä¸æ”¯æŒsafariæµè§ˆå™¨ï¼‰

å…³äº FPã€FCPã€LCPã€CLSã€TTFBã€FID ç­‰æ€§èƒ½æŒ‡æ ‡çš„å«ä¹‰å’Œè®¡ç®—æ–¹å¼

# ç”¨æˆ·è¡Œä¸ºæ•°æ®é‡‡é›†
ç”¨æˆ·è¡Œä¸ºåŒ…æ‹¬ï¼šé¡µé¢è·¯ç”±å˜åŒ–ã€é¼ æ ‡ç‚¹å‡»ã€èµ„æºåŠ è½½ã€æ¥å£è°ƒç”¨ã€ä»£ç æŠ¥é”™ç­‰è¡Œä¸º

è®¾è®¡æ€è·¯
1ã€é€šè¿‡Breadcrumbç±»æ¥åˆ›å»ºç”¨æˆ·è¡Œä¸ºçš„å¯¹è±¡ï¼Œæ¥å­˜å‚¨å’Œç®¡ç†æ‰€æœ‰çš„ç”¨æˆ·è¡Œä¸º

2ã€é€šè¿‡é‡å†™æˆ–æ·»åŠ ç›¸åº”çš„äº‹ä»¶ï¼Œå®Œæˆç”¨æˆ·è¡Œä¸ºæ•°æ®çš„é‡‡é›†

ç”¨æˆ·è¡Œä¸ºä»£ç ç¤ºä¾‹ï¼š

```js
// åˆ›å»ºç”¨æˆ·è¡Œä¸ºç±»
class Breadcrumb {
  // maxBreadcrumbsæ§åˆ¶ä¸ŠæŠ¥ç”¨æˆ·è¡Œä¸ºçš„æœ€å¤§æ¡æ•°
  maxBreadcrumbs = 20;
  // stack å­˜å‚¨ç”¨æˆ·è¡Œä¸º
  stack = [];
  constructor() {}
  // æ·»åŠ ç”¨æˆ·è¡Œä¸ºæ ˆ
  push(data) {
    if (this.stack.length >= this.maxBreadcrumbs) {
      // è¶…å‡ºåˆ™åˆ é™¤ç¬¬ä¸€æ¡
      this.stack.shift();
    }
    this.stack.push(data);
    // æŒ‰ç…§æ—¶é—´æ’åº
    this.stack.sort((a, b) => a.time - b.time);
  }
}

let breadcrumb = new Breadcrumb();

// æ·»åŠ ä¸€æ¡é¡µé¢è·³è½¬çš„è¡Œä¸ºï¼Œä»homeé¡µé¢è·³è½¬åˆ°abouté¡µé¢
breadcrumb.push({
  type: "Route",
  form: '/home',
  to: '/about'
  url: "http://localhost:3000/index.html",
  time: "1668759320435"
});

// æ·»åŠ ä¸€æ¡ç”¨æˆ·ç‚¹å‡»è¡Œä¸º
breadcrumb.push({
  type: "Click",
  dom: "<button id='btn'>æŒ‰é’®</button>",
  time: "1668759620485"
});

// æ·»åŠ ä¸€æ¡è°ƒç”¨æ¥å£è¡Œä¸º
breadcrumb.push({
  type: "Xhr",
  url: "http://10.105.10.12/monitor/open/pushData",
  time: "1668760485550"
});

// ä¸ŠæŠ¥ç”¨æˆ·è¡Œä¸º
reportData({
  uuid: "a6481683-6d2e-4bd8-bba1-64819d8cce8c",
  stack: breadcrumb.getStack()
});
```

```js
é¡µé¢è·³è½¬
é€šè¿‡ç›‘å¬è·¯ç”±çš„å˜åŒ–æ¥åˆ¤æ–­é¡µé¢è·³è½¬ï¼Œè·¯ç”±æœ‰historyã€hashä¸¤ç§æ¨¡å¼ï¼Œhistoryæ¨¡å¼å¯ä»¥ç›‘å¬popstateäº‹ä»¶ï¼Œhashæ¨¡å¼é€šè¿‡é‡å†™ pushStateå’Œ replaceStateäº‹ä»¶
vueé¡¹ç›®ä¸­ä¸èƒ½é€šè¿‡ hashchange äº‹ä»¶æ¥ç›‘å¬è·¯ç”±å˜åŒ–ï¼Œvue-router åº•å±‚è°ƒç”¨çš„æ˜¯ history.pushState å’Œ history.replaceStateï¼Œä¸ä¼šè§¦å‘ hashchange
vue-routeræºç ï¼š
function pushState (url, replace) {
  saveScrollPosition();
  var history = window.history;
  try {
    if (replace) {
      history.replaceState({ key: _key }, '', url);
    } else {
      _key = genKey();
      history.pushState({ key: _key }, '', url);
    }
  } catch (e) {
    window.location[replace ? 'replace' : 'assign'](url);
  }
}
...

// this.$router.pushæ—¶è§¦å‘
function pushHash (path) {
  if (supportsPushState) {
    pushState(getUrl(path));
  } else {
    window.location.hash = path;
  }
}
å¤åˆ¶ä»£ç 
é€šè¿‡é‡å†™ pushStateã€replaceState äº‹ä»¶æ¥ç›‘å¬è·¯ç”±å˜åŒ–
// lastHref å‰ä¸€ä¸ªé¡µé¢çš„è·¯ç”±
let lastHref = document.location.href;
function historyReplace() {
  function historyReplaceFn(originalHistoryFn) {
    return function(...args) {
      const url = args.length > 2 ? args[2] : undefined;
      if (url) {
        const from = lastHref;
        const to = String(url);
        lastHref = to;
        // ä¸ŠæŠ¥è·¯ç”±å˜åŒ–
        reportData("routeChange", {
          from,
          to
        });
      }
      return originalHistoryFn.apply(this, args);
    };
  }
  // é‡å†™pushStateäº‹ä»¶
  replaceAop(window.history, "pushState", historyReplaceFn);
  // é‡å†™replaceStateäº‹ä»¶
  replaceAop(window.history, "replaceState", historyReplaceFn);
}

function replaceAop(source, name, fn) {
  if (source === undefined) return;
  if (name in source) {
    var original = source[name];
    var wrapped = fn(original);
    if (typeof wrapped === "function") {
      source[name] = wrapped;
    }
  }
}

```

```js
ç”¨æˆ·ç‚¹å‡»
ç»™ document å¯¹è±¡æ·»åŠ clickäº‹ä»¶ï¼Œå¹¶ä¸ŠæŠ¥
function domReplace() {
  document.addEventListener("click",({ target }) => {
      const tagName = target.tagName.toLowerCase();
      if (tagName === "body") {
        return null;
      }
      let classNames = target.classList.value;
      classNames = classNames !== "" ? ` class="${classNames}"` : "";
      const id = target.id ? ` id="${target.id}"` : "";
      const innerText = target.innerText;
      // è·å–åŒ…å«idã€classã€innerTextdeå­—ç¬¦ä¸²çš„æ ‡ç­¾
      let dom = `<${tagName}${id}${
        classNames !== "" ? classNames : ""
      }>${innerText}</${tagName}>`;
      // ä¸ŠæŠ¥
      reportData({
        type: 'Click',
        dom
      });
    },
    true
  );
}
function domReplace() {
  document.addEventListener('click',({target})=>{
    const tagName=target.tagName.toLowerCase()
    if(tagName==='body'){
      return null
    }
    let classNames=target.classList.value
  })
}

```

# èµ„æºåŠ è½½
è·å–é¡µé¢ä¸­åŠ è½½çš„èµ„æºä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒä»¬çš„ url æ˜¯ä»€ä¹ˆã€åŠ è½½äº†å¤šä¹…ã€æ˜¯å¦æ¥è‡ªç¼“å­˜ç­‰ï¼Œæœ€ç»ˆç”Ÿæˆ èµ„æºåŠ è½½ç€‘å¸ƒå›¾

ç€‘å¸ƒå›¾å±•ç°äº†æµè§ˆå™¨ä¸ºæ¸²æŸ“ç½‘é¡µè€ŒåŠ è½½çš„æ‰€æœ‰çš„èµ„æºï¼ŒåŒ…æ‹¬åŠ è½½çš„é¡ºåºå’Œæ¯ä¸ªèµ„æºçš„åŠ è½½æ—¶é—´
åˆ†æè¿™äº›èµ„æºæ˜¯å¦‚ä½•åŠ è½½çš„, å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£ç©¶ç«Ÿæ˜¯ä»€ä¹ˆåŸå› æ‹–æ…¢äº†ç½‘é¡µï¼Œä»è€Œé‡‡å–å¯¹åº”çš„æªæ–½æ¥æå‡ç½‘é¡µé€Ÿåº¦
å¯ä»¥é€šè¿‡Â performance.getEntriesByType('resource') è·å–é¡µé¢åŠ è½½çš„èµ„æºåˆ—è¡¨ï¼ŒåŒæ—¶å¯ä»¥ç»“åˆÂ initiatorType å­—æ®µæ¥åˆ¤æ–­èµ„æºç±»å‹ï¼Œå¯¹èµ„æºè¿›è¡Œè¿‡æ»¤
å…¶ä¸­ PerformanceResourceTiming æ¥åˆ†æèµ„æºåŠ è½½çš„è¯¦ç»†æ•°æ®
```js
// PerformanceResourceTiming å„å­—æ®µè¯´æ˜
{
  connectEnd, // è¡¨ç¤ºæµè§ˆå™¨å®Œæˆå»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥ä»¥æ£€ç´¢èµ„æºä¹‹åçš„æ—¶é—´
  connectStart, // è¡¨ç¤ºæµè§ˆå™¨å¼€å§‹å»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥ä»¥æ£€ç´¢èµ„æºä¹‹å‰çš„æ—¶é—´
  decodedBodySize, // è¡¨ç¤ºåœ¨åˆ é™¤ä»»ä½•åº”ç”¨çš„å†…å®¹ç¼–ç ä¹‹åï¼Œä»*æ¶ˆæ¯ä¸»ä½“*çš„è¯·æ±‚ï¼ˆHTTP æˆ–ç¼“å­˜ï¼‰ä¸­æ¥æ”¶åˆ°çš„å¤§å°ï¼ˆä»¥å…«ä½å­—èŠ‚ä¸ºå•ä½ï¼‰
  domainLookupEnd, // è¡¨ç¤ºæµè§ˆå™¨å®Œæˆèµ„æºçš„åŸŸåæŸ¥æ‰¾ä¹‹åçš„æ—¶é—´
  domainLookupStart, // è¡¨ç¤ºåœ¨æµè§ˆå™¨ç«‹å³å¼€å§‹èµ„æºçš„åŸŸåæŸ¥æ‰¾ä¹‹å‰çš„æ—¶é—´
  duration, // è¿”å›ä¸€ä¸ªtimestampï¼Œå³Â responseEnd å’Œ startTime å±æ€§çš„å·®å€¼
  encodedBodySize, // è¡¨ç¤ºåœ¨åˆ é™¤ä»»ä½•åº”ç”¨çš„å†…å®¹ç¼–ç ä¹‹å‰ï¼Œä»*æœ‰æ•ˆå†…å®¹ä¸»ä½“*çš„è¯·æ±‚ï¼ˆHTTP æˆ–ç¼“å­˜ï¼‰ä¸­æ¥æ”¶åˆ°çš„å¤§å°ï¼ˆä»¥å…«ä½å­—èŠ‚ä¸ºå•ä½ï¼‰
  entryType, // è¿”å›Â "resource"
  fetchStart, // è¡¨ç¤ºæµè§ˆå™¨å³å°†å¼€å§‹è·å–èµ„æºä¹‹å‰çš„æ—¶é—´
  initiatorType, // ä»£è¡¨å¯åŠ¨æ€§èƒ½æ¡ç›®çš„èµ„æºçš„ç±»å‹ï¼Œå¦‚Â PerformanceResourceTiming.initiatorTypeÂ ä¸­æ‰€æŒ‡å®š
  name, // è¿”å›èµ„æº URL
  nextHopProtocol, // ä»£è¡¨ç”¨äºè·å–èµ„æºçš„ç½‘ç»œåè®®
  redirectEnd, // è¡¨ç¤ºæ”¶åˆ°ä¸Šä¸€æ¬¡é‡å®šå‘å“åº”çš„å‘é€æœ€åä¸€ä¸ªå­—èŠ‚æ—¶çš„æ—¶é—´
  redirectStart, // è¡¨ç¤ºä¸Šä¸€æ¬¡é‡å®šå‘å¼€å§‹çš„æ—¶é—´
  requestStart, // è¡¨ç¤ºæµè§ˆå™¨å¼€å§‹å‘æœåŠ¡å™¨è¯·æ±‚èµ„æºä¹‹å‰çš„æ—¶é—´
  responseEnd, // è¡¨ç¤ºåœ¨æµè§ˆå™¨æ¥æ”¶åˆ°èµ„æºçš„æœ€åä¸€ä¸ªå­—èŠ‚ä¹‹åæˆ–åœ¨ä¼ è¾“è¿æ¥å…³é—­ä¹‹å‰ï¼ˆä»¥å…ˆåˆ°è€…ä¸ºå‡†ï¼‰çš„æ—¶é—´
  responseStart, // è¡¨ç¤ºæµè§ˆå™¨ä»æœåŠ¡å™¨æ¥æ”¶åˆ°å“åº”çš„ç¬¬ä¸€ä¸ªå­—èŠ‚åçš„æ—¶é—´
  secureConnectionStart, // è¡¨ç¤ºæµè§ˆå™¨å³å°†å¼€å§‹æ¡æ‰‹è¿‡ç¨‹ä»¥ä¿æŠ¤å½“å‰è¿æ¥ä¹‹å‰çš„æ—¶é—´
  serverTiming, // ä¸€ä¸ªÂ PerformanceServerTimingÂ æ•°ç»„ï¼ŒåŒ…å«æœåŠ¡å™¨è®¡æ—¶æŒ‡æ ‡çš„PerformanceServerTimingÂ æ¡ç›®
  startTime, // è¡¨ç¤ºèµ„æºè·å–å¼€å§‹çš„æ—¶é—´ã€‚è¯¥å€¼ç­‰æ•ˆäºÂ PerformanceEntry.fetchStart
  transferSize, // ä»£è¡¨æ‰€è·å–èµ„æºçš„å¤§å°ï¼ˆä»¥å…«ä½å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚è¯¥å¤§å°åŒ…æ‹¬å“åº”æ ‡å¤´å­—æ®µä»¥åŠå“åº”æœ‰æ•ˆå†…å®¹ä¸»ä½“
  workerStart // å¦‚æœæœåŠ¡ Worker çº¿ç¨‹å·²ç»åœ¨è¿è¡Œï¼Œåˆ™è¿”å›åœ¨åˆ†æ´¾Â FetchEvent ä¹‹å‰çš„æ—¶é—´æˆ³ï¼Œå¦‚æœå°šæœªè¿è¡Œï¼Œåˆ™è¿”å›åœ¨å¯åŠ¨ Service Worker çº¿ç¨‹ä¹‹å‰çš„æ—¶é—´æˆ³ã€‚å¦‚æœæœåŠ¡ Worker æœªæ‹¦æˆªè¯¥èµ„æºï¼Œåˆ™è¯¥å±æ€§å°†å§‹ç»ˆè¿”å› 0ã€‚
}
```
è·å–èµ„æºåŠ è½½æ—¶é•¿ä¸º duration å­—æ®µï¼Œå³ responseEnd ä¸ startTime çš„å·®å€¼

è·å–åŠ è½½èµ„æºåˆ—è¡¨ï¼š


```js
function getResource() {
  if (performance.getEntriesByType) {
    const entries = performance.getEntriesByType('resource');
    // è¿‡æ»¤æ‰éé™æ€èµ„æºçš„ fetchã€ xmlhttprequestã€beacon
    let list = entries.filter((entry) => {
      return ['fetch', 'xmlhttprequest', 'beacon'].indexOf(entry.initiatorType) === -1;
    });

    if (list.length) {
      list = JSON.parse(JSON.stringify(list));
      list.forEach((entry) => {
        entry.isCache = isCache(entry);
      });
    }
    return list;
  }
}

// åˆ¤æ–­èµ„æ–™æ˜¯å¦æ¥è‡ªç¼“å­˜
// transferSizeä¸º0ï¼Œè¯´æ˜æ˜¯ä»ç¼“å­˜ä¸­ç›´æ¥è¯»å–çš„ï¼ˆå¼ºåˆ¶ç¼“å­˜ï¼‰
// transferSizeä¸ä¸º0ï¼Œä½†æ˜¯`encodedBodySize` å­—æ®µä¸º 0ï¼Œè¯´æ˜å®ƒèµ°çš„æ˜¯åå•†ç¼“å­˜ï¼ˆ`encodedBodySize è¡¨ç¤ºè¯·æ±‚å“åº”æ•°æ® body çš„å¤§å°`ï¼‰
function isCache(entry) {
  return entry.transferSize === 0 || (entry.transferSize !== 0 && entry.encodedBodySize === 0);
}
```
ä¸€ä¸ªçœŸå®çš„é¡µé¢ä¸­ï¼Œèµ„æºåŠ è½½å¤§å¤šæ•°æ˜¯é€æ­¥è¿›è¡Œçš„ï¼Œæœ‰äº›èµ„æºæœ¬èº«å°±åšäº†å»¶è¿ŸåŠ è½½ï¼Œæœ‰äº›æ˜¯éœ€è¦ç”¨æˆ·å‘ç”Ÿäº¤äº’åæ‰ä¼šå»è¯·æ±‚ä¸€äº›èµ„æº
å¦‚æœæˆ‘ä»¬åªå…³æ³¨é¦–é¡µèµ„æºï¼Œå¯ä»¥åœ¨ window.onload äº‹ä»¶ä¸­å»æ”¶é›†
å¦‚æœè¦æ”¶é›†æ‰€æœ‰çš„èµ„æºï¼Œéœ€è¦é€šè¿‡å®šæ—¶å™¨åå¤åœ°å»æ”¶é›†ï¼Œå¹¶ä¸”åœ¨ä¸€è½®æ”¶é›†ç»“æŸåï¼Œé€šè¿‡è°ƒç”¨Â clearResourceTimingsÂ å°† performance entries é‡Œçš„ä¿¡æ¯æ¸…ç©ºï¼Œé¿å…åœ¨ä¸‹ä¸€è½®æ”¶é›†æ—¶å–åˆ°é‡å¤çš„èµ„æº


# ä¸ªæ€§åŒ–æŒ‡æ ‡
long task
è¶…è¿‡50msçš„ä»»åŠ¡
è·å–é¡µé¢çš„é•¿ä»»åŠ¡åˆ—è¡¨ï¼š


```js
const entryHandler=list=>{
  for(const longTask of list.getEntries()){
    // è·å–é•¿ä»»åŠ¡è¯¦æƒ…
    console.log(longTask)
  }
}

let observer = new PerformanceObserver(entryHandler)
observer.observe({entryTypes: ['longtask']})


```

## memoryé¡µé¢å†…å­˜

performance.memory å¯ä»¥æ˜¾ç¤ºæ­¤åˆ»å†…å­˜å ç”¨æƒ…å†µï¼Œæ˜¯ä¸€ä¸ªåŠ¨æ€å€¼ï¼ŒjsHeapSizeLimitå†…å­˜å¤§å°çš„é™åˆ¶
totalJSHeapSizeæ€»å†…å­˜çš„å¤§å°
usedJSHeapSizeå¯ä½¿ç”¨çš„å†…å­˜å¤§å°
usedä¸èƒ½å¤§äºtotalï¼Œå¦‚æœå¤§äºï¼Œæœ‰å¯èƒ½å‡ºç°äº†å†…å­˜æ³„æ¼
```js
window.addEventListener('load',()=>{
  console.log('memory',performance.memory)
})
```
# é¦–å±åŠ è½½æ—¶é—´
é¦–å±åŠ è½½æ—¶é—´å’Œé¦–é¡µåŠ è½½æ—¶é—´ä¸ä¸€æ ·ï¼Œé¦–å±æŒ‡çš„æ˜¯å±å¹•å†…çš„domæ¸²æŸ“å®Œæˆçš„æ—¶é—´

æ¯”å¦‚é¦–é¡µå¾ˆé•¿éœ€è¦å¥½å‡ å±å±•ç¤ºï¼Œè¿™ç§æƒ…å†µä¸‹å±å¹•ä»¥å¤–çš„å…ƒç´ ä¸è€ƒè™‘åœ¨å†…

## è®¡ç®—é¦–å±åŠ è½½æ—¶é—´æµç¨‹

1ï¼‰åˆ©ç”¨MutationObserverç›‘å¬documentå¯¹è±¡ï¼Œæ¯å½“domå˜åŒ–æ—¶è§¦å‘è¯¥äº‹ä»¶
2ï¼‰åˆ¤æ–­ç›‘å¬çš„domæ˜¯å¦åœ¨é¦–å±å†…ï¼Œå¦‚æœåœ¨é¦–å±å†…ï¼Œå°†è¯¥domæ”¾åˆ°æŒ‡å®šçš„æ•°ç»„ä¸­ï¼Œè®°å½•ä¸‹å½“å‰domå˜åŒ–çš„æ—¶é—´ç‚¹
3ï¼‰åœ¨MutationObserverçš„callbackå‡½æ•°ä¸­ï¼Œé€šè¿‡é˜²æŠ–å‡½æ•°ï¼Œç›‘å¬document.readyStateçŠ¶æ€çš„å˜åŒ–
4ï¼‰å½“document.readyState === 'complete'ï¼Œåœæ­¢å®šæ—¶å™¨å’Œ å–æ¶ˆå¯¹documentçš„ç›‘å¬
5ï¼‰éå†å­˜æ”¾domçš„æ•°ç»„ï¼Œæ‰¾å‡ºæœ€åå˜åŒ–èŠ‚ç‚¹çš„æ—¶é—´ï¼Œç”¨è¯¥æ—¶é—´ç‚¹å‡å»performance.timing.navigationStart å¾—å‡ºé¦–å±çš„åŠ è½½æ—¶é—´

## ç›‘æ§SDK
ä½œç”¨ï¼šæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥
æ•´ä½“æ¶æ„ï¼š
triggerHandlers-å‘å¸ƒ->handlers[]è®¢é˜…ä¸­å¿ƒã€Š-è®¢é˜…äº‹ä»¶=ï¼Œ-è§¦å‘å›è°ƒ
æ•´ä½“æ¶æ„ä½¿ç”¨ å‘å¸ƒ-è®¢é˜… è®¾è®¡æ¨¡å¼ï¼Œè¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ä¾¿äºåç»­æ‰©å±•ä¸ç»´æŠ¤ï¼Œå¦‚æœæƒ³æ·»åŠ æ–°çš„hookæˆ–äº‹ä»¶ï¼Œåœ¨è¯¥å›è°ƒä¸­æ·»åŠ å¯¹åº”çš„å‡½æ•°å³å¯

vueé¡¹ç›®åœ¨Vue.config.errorHandlerä¸­ä¸ŠæŠ¥é”™è¯¯ï¼Œreacté¡¹ç›®åœ¨ErrorBoundaryä¸­ä¸ŠæŠ¥é”™è¯¯

# äº‹ä»¶å‘å¸ƒä¸è®¢é˜…
é€šè¿‡æ·»åŠ äº‹ä»¶æ¥æ•è·é”™è¯¯ï¼Œåˆ©ç”¨AOPåˆ‡ç‰‡ç¼–ç¨‹ï¼Œé‡å†™æ¥å£è¯·æ±‚ã€è·¯ç”±ç›‘å¬ç­‰åŠŸèƒ½ï¼Œä»è€Œè·å–å¯¹åº”çš„æ•°æ®ã€‚
# ç”¨æˆ·è¡Œä¸ºæ”¶é›†
core/breadcrumb.js åˆ›å»ºç”¨æˆ·è¡Œä¸ºç±»ï¼Œstackç”¨æ¥å­˜å‚¨ç”¨æˆ·è¡Œä¸ºï¼Œå½“é•¿åº¦è¶…è¿‡é™åˆ¶æ—¶ï¼Œæœ€æ—©çš„ä¸€æ¡æ•°æ®ä¼šè¢«è¦†ç›–æ‰ï¼Œåœ¨ä¸ŠæŠ¥é”™è¯¯æ—¶ï¼Œå¯¹åº”çš„ç”¨æˆ·è¡Œä¸ºä¼šæ·»åŠ åˆ°è¯¥é”™è¯¯ä¿¡æ¯ä¸­ã€‚
```js
// core/breadcrumb.js
export class BreadCrumb {
  constructor(){
    this.maxBreadcrumbs=20
    this.beforePushBreadcrumb=null
    this.stack=[]
  }
  æ·»åŠ ç”¨æˆ·è¡Œä¸ºæ ˆ
  push(data){
    if(typeof this.beforePushBreadcrumb==='function'){
      // æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„hook
      let result=this.beforePushBreadcrumb(this,data)
      if(!result)return
      this.immediatePush(result)
      return
    }
    this.immediatePush(data)
  }
  immediatePush(data){
    data.time||(data.time=getTimestamp())
    if(this.stack.length>=this.maxBreadcrumbs)this.shift()
    this.stack.push(data)
    this.stack.sort((a,b)=>a.time-b.time)
  }
}
```
# æ•°æ®ä¸ŠæŠ¥æ–¹å¼
æ”¯æŒå›¾ç‰‡æ‰“ç‚¹ä¸ŠæŠ¥å’Œfetchè¯·æ±‚ä¸ŠæŠ¥ä¸¤ç§æ–¹å¼

å›¾ç‰‡æ‰“ç‚¹ä¸ŠæŠ¥çš„ä¼˜åŠ¿ï¼š
1. æ”¯æŒè·¨åŸŸï¼Œä¸€èˆ¬è€Œè¨€ï¼Œä¸ŠæŠ¥åŸŸåéƒ½ä¸æ˜¯å½“å‰åŸŸå
2. ä½“ç§¯å°ä¸”ä¸éœ€è¦æ’å…¥DOMä¸­
3. ä¸éœ€è¦ç­‰å¾…æœåŠ¡å™¨è¿”å›æ•°æ®

ç¼ºç‚¹ï¼šurlå—æµè§ˆå™¨é•¿åº¦é™åˆ¶
```js
// core/transportData.js
async send(data){
  let dsn=this.errorDsn
  if(isEmpty(dsn)){
    console.error('web-see:dsnä¸ºç©ºï¼Œæ²¡æœ‰ä¼ å…¥ç›‘æ§é”™è¯¯ä¸ŠæŠ¥çš„dsnåœ°å€ï¼Œè¯·åœ¨initä¸­ä¼ å…¥')
    return
  }
  // å¼€å¯å½•å±
  if(_support.options.silientRecordScreen){
    if(options.recordScreenTypeList.includes(data.type)){
      // ä¿®æ”¹hasError
      _support.hasError=true
      data.recordScreenId=_suppport.recordScreenId
    }
  }
  const result=await this.beforePost(data)
  if(isBrowserEnv){
    // æ”¯æŒå›¾ç‰‡æ‰“ç‚¹ä¸ŠæŠ¥å’Œfetchä¸ŠæŠ¥
    return this.useImgUpload?this.imgRequest(resutl,dsn):this.xhrPost(result,dsn)
  }
}
```
##ã€€ä¸ŠæŠ¥æ—¶æœº
ä¼˜å…ˆä½¿ç”¨ï½’ï½…ï½‘ï½•ï½…ï½“ï½”ï¼©ï½„ï½Œï½…ï¼£ï½ï½Œï½Œï½‚ï½ï½ƒï½‹ï¼Œåˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´ä¸ŠæŠ¥ï¼Œå…¶æ¬¡ä½¿ç”¨å¾®ä»»åŠ¡ä¸ŠæŠ¥
```js
export class Queue{
  constructor(){
    this.stack=[]
    this.isFlushing=false
  }
  addFn(fn){
    if(typeof fn!=='function')return
    if(!('requestIdleCallback' in _global ||'Promise' in _global)){
      fn()
      return
    }
    this.stack.push(fn)
    if(!this.isFlushing){
      this.isFlushing=true
      // ä¼˜å…ˆä½¿ç”¨requestIdleCallback
      if('requestIdleCallback' in _global){
        requestIdleCallback(()=>this.flushStack())
      }else{
        // å…¶æ¬¡ä½¿ç”¨å¾®ä»»åŠ¡ä¸ŠæŠ¥
        Promise.resolve().then(()=>this.flushStack())
      }
    }
  }
  clear(){
    this.stack=[]
  }
}
```
ç›‘æ§SDKï¼Œå‚è€ƒäº†sentryã€monitorã€mitojs

é¡¹ç›®åå°Demo
æ¼”ç¤ºé”™è¯¯è¿˜åŸåŠŸèƒ½ï¼Œæ–¹å¼åŒ…æ‹¬ï¼šå®šä½æºç ã€æ’­æ”¾å½•å±ã€è®°å½•ç”¨æˆ·è¡Œä¸º
åŠŸèƒ½ä»‹ç»ï¼š
1. ä½¿ç”¨expresså¼€å¯é™æ€æœåŠ¡å™¨ï¼Œæ¨¡æ‹Ÿçº¿ä¸Šç¯å¢ƒï¼Œç”¨äºå®ç°å®šä½æºç çš„åŠŸèƒ½
2. server.jsä¸­å®ç°äº†reportDataé”™è¯¯ä¸ŠæŠ¥ã€getmapè·å–mapæ–‡ä»¶ã€getRecordScreenIdè·å–å½•å±ä¿¡æ¯ã€getErrorListçš„æ¥å£
3. ç”¨æˆ·å¯ç‚¹å‡»jsæŠ¥é”™ã€å¼‚æ­¥æŠ¥é”™ã€promiseé”™è¯¯æŒ‰é’®ï¼Œä¸ŠæŠ¥å¯¹åº”çš„ä»£ç é”™è¯¯ï¼Œåå°å®ç°é”™è¯¯è¿˜åŸåŠŸèƒ½
4. ç‚¹å‡»â€˜xhrè¯·æ±‚æŠ¥é”™â€™ã€â€˜fetchè¯·æ±‚æŠ¥é”™â€™æŒ‰é’®ï¼Œä¸ŠæŠ¥æ¥å£æŠ¥é”™ä¿¡æ¯
5. ç‚¹å‡»â€˜åŠ è½½èµ„æºæŠ¥é”™â€™æŒ‰é’®ï¼Œä¸ŠæŠ¥å¯¹åº”çš„èµ„æºæŠ¥é”™ä¿¡æ¯

é€šè¿‡è¿™äº›å¼‚å¸¸çš„æ•è·ï¼Œäº†è§£ç›‘æ§å¹³å°çš„æ•´ä½“æµç¨‹
web-see

```js
$ npm i web-see

import webSee from 'web-see'
Vue.use(webSee,{
  dsn:'http://localhost:8083/reportData', // reportUrl
  apikey: 'project1', // é¡¹ç›®å”¯ä¸€çš„id
  userId:'89757',
  silientRecordScreen:true// å¼€å¯å½•å±ï¼Œé»˜è®¤å…³é—­
})

// React
import webSee from 'web-see'
webSee.init({
  dsn:'http://',
  apikey:'',
  userId:'',
})
```

# å¦‚ä½•å®ç°é”™è¯¯è¿˜åŸåŠŸèƒ½ï¼š

## å®šä½æºç 
ä»£ç åè§£ ï¼Œå‹ç¼©ã€æ··æ·†ã€åŠ å¯†ï¼Œçº¿ä¸Šä»£ç æŠ¥é”™æ—¶ï¼Œå¾ˆéš¾å®šä½åˆ°å…·ä½“çš„æºç ã€‚xxx.js xxx.js.mapã€‚mapæ–‡ä»¶åŒ…å«äº†åŸå§‹ä»£ç åŠå…¶æ˜ å°„ä¿¡æ¯ï¼Œå¯ä»¥åˆ©ç”¨å®ƒåˆ†è§£å‡ºæŠ¥é”™ä¿¡æ¯çš„æºç 
##ã€€ï¼³ï½ï½•ï½’ï½ƒï½…ï¼­ï½ï½æ–‡ä»¶ã€€
ä¾‹å¦‚ app.a2a3ceec.js ä»£ç å¦‚ä¸‹ï¼š


```js
varÂ add=function(x,Â y){returnÂ x+y;};
//#Â sourceMappingURL=app.a2a3ceec.js.map
```
å…¶ä¸­ sourceMappingURL ç”¨æ¥è¯´æ˜è¯¥æ–‡ä»¶å¯¹åº”çš„mapæ–‡ä»¶

å¯¹åº”çš„ app.a2a3ceec.js.map ä»£ç å¦‚ä¸‹ï¼š

```js
{
  versionÂ :Â 3,Â //Â SourceMapæ ‡å‡†ç‰ˆæœ¬,æœ€æ–°çš„ä¸º3
  file:Â "js/app.a2a3ceec.js",Â //Â è½¬æ¢åçš„æ–‡ä»¶å
  sourceRootÂ :Â "",Â //Â è½¬æ¢å‰çš„æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œå¦‚æœä¸è½¬æ¢å‰çš„æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ï¼Œè¯¥é¡¹ä¸ºç©º
  sources:Â [ //Â è½¬æ¢å‰çš„æ–‡ä»¶ï¼Œè¯¥é¡¹æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¡¨ç¤ºå¯èƒ½å­˜åœ¨å¤šä¸ªæ–‡ä»¶åˆå¹¶
    "webpack://web-see-demo/./src/App.vue",
    "webpack://web-see-demo/./src/main.js"
  ],Â 
  names:Â [],Â //Â è½¬æ¢å‰çš„æ‰€æœ‰å˜é‡åå’Œå±æ€§å
  sourcesContent:Â [Â //Â åŸå§‹æ–‡ä»¶å†…å®¹
 Â Â  "constÂ addÂ =Â (x,y)Â =>Â {\nÂ Â returnÂ x+y;\n}"
  ],
  // æ‰€æœ‰æ˜ å°„ç‚¹
  mappings:Â "AAAA,IAAM,GAAG,GAAG,UAAC,CAAQ,EAAC,CAAQ;IAC5B,OAAO,CAAC,GAAC,CAAC,CAAC;AACb,CAAC,CAAA"
}
```
å…¶ä¸­ sources å’Œ sourcesContent æ˜¯å…³é”®å­—æ®µï¼Œä¸‹æ–‡çš„è¿˜åŸç¤ºä¾‹ä¸­å°†ç”¨åˆ°

source-map-js åº“
ä»£ç è¿˜åŸï¼Œè¿™é‡Œä¸»è¦ä½¿ç”¨ source-map-js åº“ï¼Œä¸‹é¢ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨

```js
import sourceMap from 'source-map-js';

/**
* findCodeBySourceMapç”¨äºè·å–mapæ–‡ä»¶å¯¹åº”çš„æºä»£ç 
* @param { string } fileName .mapæ–‡ä»¶åç§°
* @param { number } line å‘ç”Ÿé”™è¯¯çš„è¡Œå·
* @param { number } column å‘ç”Ÿé”™è¯¯çš„åˆ—å·
* @param { function } å›è°ƒå‡½æ•°ï¼Œè¿”å›å¯¹åº”çš„æºç 
*/
const findCodeBySourceMap = async ({ fileName, line, column }, callback) => {
  // loadSourceMap ç”¨äºè·å–æœåŠ¡å™¨ä¸Š .map çš„æ–‡ä»¶å†…å®¹
  let sourceData = await loadSourceMap(fileName);
  let { sourcesContent, sources } = sourceData;
  // SourceMapConsumerå®ä¾‹è¡¨ç¤ºä¸€ä¸ªå·²è§£æçš„æºæ˜ å°„
  // å¯ä»¥é€šè¿‡åœ¨ç”Ÿæˆçš„æºä¸­ç»™å®ƒä¸€ä¸ªæ–‡ä»¶ä½ç½®æ¥æŸ¥è¯¢æœ‰å…³åŸå§‹æ–‡ä»¶ä½ç½®çš„ä¿¡æ¯
  let consumer = await new sourceMap.SourceMapConsumer(sourceData);
  // è¾“å…¥é”™è¯¯çš„å‘ç”Ÿè¡Œå’Œåˆ—ï¼Œå¯ä»¥å¾—åˆ°æºç å¯¹åº”åŸå§‹æ–‡ä»¶ã€è¡Œå’Œåˆ—ä¿¡æ¯
  let result = consumer.originalPositionFor({
    line: Number(line),
    column: Number(column)
  });
  // ä»sourcesContentå¾—åˆ°å…·ä½“çš„æºç ä¿¡æ¯
  let code = sourcesContent[sources.indexOf(result.source)];
  â€¦â€¦
  callback(code)
```

source-map çš„è¿˜åŸæµç¨‹ï¼š
1ã€ä»æœåŠ¡å™¨è·å–æŒ‡å®š.map çš„æ–‡ä»¶å†…å®¹
2ã€new ä¸€ä¸ª SourceMapConsumer çš„å®ä¾‹ï¼Œè¡¨ç¤ºä¸€ä¸ªå·²è§£æçš„æºæ˜ å°„ï¼Œç»™å®ƒä¸€ä¸ªæ–‡ä»¶ä½ç½®æ¥æŸ¥è¯¢æœ‰å…³åŸå§‹æ–‡ä»¶ä½ç½®çš„ä¿¡æ¯
3ã€è¾“å…¥æŠ¥é”™å‘ç”Ÿçš„è¡Œå’Œåˆ—ï¼Œå¯ä»¥å¾—åˆ°æºç å¯¹åº”åŸå§‹æ–‡ä»¶åã€è¡Œå’Œåˆ—ä¿¡æ¯
4ã€ä»æºæ–‡ä»¶çš„ sourcesContent å­—æ®µä¸­ï¼Œè·å–å¯¹åº”çš„æºç ä¿¡æ¯
æ¥ä¸‹æ¥çš„é‡ç‚¹å°±å˜ä¸ºï¼šå¦‚ä½•è·å–æŠ¥é”™å‘ç”Ÿçš„åŸå§‹æ–‡ä»¶åã€è¡Œå’Œåˆ—ä¿¡æ¯
error-stack-parser åº“
é€šè¿‡ç¬¬ä¸€ç¯‡æ–‡ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼æ¥æ•è·æŠ¥é”™
æ¯”å¦‚ erroräº‹ä»¶ã€unhandledrejectionäº‹ä»¶ã€vue ä¸­é€šè¿‡Vue.config.errorHanderã€reactä¸­é€šè¿‡componentDidCatch
ä¸ºäº†æ¶ˆé™¤å„æµè§ˆå™¨çš„å·®å¼‚ï¼Œä½¿ç”¨ error-stack-parser åº“æ¥æå–ç»™å®šé”™è¯¯çš„åŸå§‹æ–‡ä»¶åã€è¡Œå’Œåˆ—ä¿¡æ¯
ç¤ºä¾‹ä»£ç ï¼š
```js
import ErrorStackParser from 'error-stack-parser';

ErrorStackParser.parse(new Error('BOOM'));

// è¿”å›å€¼ StackFrame å †æ ˆåˆ—è¡¨
[
    StackFrame({functionName: 'foo', args: [], fileName: 'path/to/file.js', lineNumber: 35, columnNumber: 79, isNative: false, isEval: false}),
    StackFrame({functionName: 'Bar', fileName: 'https://cdn.somewherefast.com/utils.min.js', lineNumber: 1, columnNumber: 832, isNative: false, isEval: false, isConstructor: true}),
    StackFrame(... and so on ...)
]
```
å®šä½æºç æµç¨‹æ€»ç»“ï¼š
1ã€é¡¹ç›®ä¸­å¼•å…¥ç›‘æ§ SDKï¼Œæ‰“åŒ…åå°†jsæ–‡ä»¶å‘å¸ƒåˆ°æœåŠ¡å™¨ä¸Š
2ã€å°† .map æ–‡ä»¶æ”¾åˆ°æŒ‡å®šçš„åœ°å€ï¼Œç»Ÿä¸€å­˜å‚¨
3ã€å½“çº¿ä¸Šä»£ç æŠ¥é”™æ—¶ï¼Œåˆ©ç”¨ error-stack-parser è·å–å…·ä½“åŸå§‹æ–‡ä»¶åã€è¡Œå’Œåˆ—ä¿¡æ¯ï¼Œå¹¶ä¸ŠæŠ¥
4ã€åˆ©ç”¨ source-map ä» .map æ–‡ä»¶ä¸­å¾—åˆ°å¯¹åº”çš„æºç å¹¶å±•ç¤º

# å‰ç«¯å½•å±

rrweb
```js
// å½•åˆ¶ç¤ºä¾‹
import { record } from 'rrweb';
// eventså­˜å‚¨å½•å±ä¿¡æ¯
let events = [];
// record ç”¨äºè®°å½•Â `DOM`Â ä¸­çš„æ‰€æœ‰å˜æ›´
rrweb.record({
  emit(event, isCheckout) {
    // isCheckout æ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œå‘Šè¯‰ä½ é‡æ–°åˆ¶ä½œäº†å¿«ç…§
    if (isCheckout) {
      events.push([]);
    }
    events.push(event);
  },
  recordCanvas: true, // è®°å½• canvas å†…å®¹
  checkoutEveryNms: 10 * 1000, // æ¯10sé‡æ–°åˆ¶ä½œå¿«ç…§
  checkoutEveryNth: 200, // æ¯ 200 ä¸ª event é‡æ–°åˆ¶ä½œå¿«ç…§
});

```
```html
<!-- æ’­æ”¾ç¤ºä¾‹ -->
<template>
  <div ref='player'>
  </div>
</template>
<script>
import rrwebPlayer from 'rrweb-player';
import 'rrweb-player/dist/style.css';
export default {
   mounted() {
     // å°†è®°å½•çš„å˜æ›´æŒ‰ç…§å¯¹åº”çš„æ—¶é—´ä¸€ä¸€é‡æ”¾
     new rrwebPlayer(
        {
          target: this.$refs.player, // å›æ”¾æ‰€éœ€è¦çš„HTMLå…ƒç´ 
          data: { events }
        },
        {
          UNSAFE_replayCanvas: true // å›æ”¾ canvas å†…å®¹
        }
     )
   }
}
</script>
```
## rrwebåŸç†æµ…æ
ä¸»è¦ç”±rrweb,rrweb-player,rrweb-snapshotç»„æˆ
1. rrwebï¼šæä¾›äº†recordå’Œreplayä¸¤æ–¹æ³•ï¼Œrecordç”¨æ¥è®°å½•é¡µé¢ä¸ŠDOMå˜åŒ–ï¼Œreplayæ”¯æŒæ ¹æ®æ—¶é—´æˆ³è¿˜åŸDOMçš„å˜åŒ–
2. rrweb-playerï¼š åŸºäºsvelteæ¨¡æ¿å®ç°ï¼Œä¸ºrrwebæä¾›äº†å›æ”¾çš„GUIå·¥å…·ï¼Œæ”¯æŒæš‚åœã€å€é€Ÿæ’­æ”¾ã€æ‹–æ‹½æ—¶é—´è½´ç­‰åŠŸèƒ½ï¼Œå†…éƒ¨è°ƒç”¨äº†rrwebereplayç­‰æ–¹æ³•
3. rrweb-snapshotï¼šåŒ…æ‹¬snapshotå’Œrebuildingä¸¤ç‰¹æ€§ï¼Œå‰è€…åºåˆ—åŒ–DOMä¸ºå¢é‡å¿«ç…§ï¼Œåè€…å°†å¢é‡å¿«ç…§è¿˜åŸä¸ºDOM

rrwebæ•´ä½“æµç¨‹ï¼š
1. rrwebåœ¨å½•åˆ¶æ—¶ä¼šé¦–å…ˆè¿›è¡Œé¦–å±DOMå¿«ç…§ï¼Œéå†æ•´ä¸ªé¡µé¢çš„DOMæ ‘ï¼Œè½¬æ¢ä¸ºJSONç»“æ„æ•°æ®ï¼Œä½¿ç”¨å¢é‡å¿«ç…§çš„å¤„ç†æ–¹å¼ï¼Œé€šè¿‡ mutationObserver è·å– DOM å¢é‡å˜åŒ–ï¼ŒåŒæ­¥è½¬æ¢ä¸º JSON æ•°æ®è¿›è¡Œå­˜å‚¨

2. æ•´ä¸ªå½•åˆ¶çš„è¿‡ç¨‹ä¼šç”Ÿæˆ unique idï¼Œæ¥ç¡®å®šå¢é‡æ•°æ®æ‰€å¯¹åº”çš„ DOM èŠ‚ç‚¹ï¼Œé€šè¿‡ timestamp ä¿è¯å›æ”¾é¡ºåºã€‚
3. å›æ”¾æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª iframe ä½œä¸ºæ‰¿è½½äº‹ä»¶å›æ”¾çš„å®¹å™¨ï¼Œé’ˆå¯¹é¦–å±Â DOMÂ å¿«ç…§è¿›è¡Œé‡å»ºï¼Œåœ¨éå†Â JSONÂ çš„åŒæ—¶ï¼Œæ ¹æ®åºåˆ—åŒ–åçš„èŠ‚ç‚¹æ•°æ®æ„å»ºå‡ºå®é™…çš„ DOM èŠ‚ç‚¹
4. rrweb å¯ä»¥ç›‘å¬çš„ç”¨æˆ·è¡Œä¸ºåŒ…æ‹¬ï¼šé¼ æ ‡ç§»åŠ¨ï¼Œé¼ æ ‡äº¤äº’ï¼Œé¡µé¢æ»šåŠ¨ï¼Œè§†çª—å˜åŒ–ã€ç”¨æˆ·è¾“å…¥ç­‰ï¼Œé€šè¿‡æ·»åŠ ç›¸åº”çš„ç›‘å¬äº‹ä»¶æ¥å®ç°

## å‹ç¼©æ•°æ®
å¦‚æœä¸€ç›´å½•å±ï¼Œæ•°æ®é‡æ˜¯å·¨å¤§çš„
å®æµ‹ä¸‹æ¥ï¼Œå½•åˆ¶10sçš„æ—¶é•¿ï¼Œæ•°æ®å¤§å°çº¦ä¸º 8M å·¦å³ï¼ˆé¡µé¢çš„ä¸åŒå¤æ‚åº¦ã€ç”¨æˆ·ä¸åŒæ“ä½œçš„é¢‘ç‡éƒ½ä¼šé€ æˆå¤§å°ä¸ä¸€æ ·ï¼‰
æ•°æ®å¦‚æœä¸ç»è¿‡å‹ç¼©ï¼Œç›´æ¥ä¼ ç»™åç«¯ï¼Œé¢å¯¹å¤§é‡çš„ç”¨æˆ·ï¼Œéœ€è¦éå¸¸é«˜çš„å¸¦å®½åšæ”¯æŒã€‚è¿˜å¥½ï¼Œrrwebå®˜æ–¹æä¾›äº†æ•°æ®å‹ç¼©å‡½æ•°
åŸºäº packFn çš„å•æ•°æ®å‹ç¼©ï¼Œåœ¨å½•åˆ¶æ—¶å¯ä»¥ä½œä¸ºÂ packFnÂ ä¼ å…¥
rrweb.record({
  emit(event) {},
  packFn: rrweb.pack,
});
å¤åˆ¶ä»£ç 
å›æ”¾æ—¶ï¼Œéœ€è¦ä¼ å…¥ rrweb.unpack ä½œä¸ºÂ unpackFnÂ ä¼ å…¥
const replayer = new rrweb.Replayer(events, {
  unpackFn: rrweb.unpack,
});
å¤åˆ¶ä»£ç 
ä½†æ˜¯å®˜æ–¹æä¾›çš„å‹ç¼©æ–¹å¼ï¼Œæ˜¯å¯¹æ¯ä¸ª event æ•°æ®å•ç‹¬è¿›è¡Œå‹ç¼©ï¼Œå‹ç¼©æ¯”ä¸é«˜ã€‚å®æµ‹ä¸‹æ¥ï¼Œå‹ç¼©æ¯”åœ¨70%å·¦å³ï¼Œæ¯”å¦‚åŸæ¥ 8M çš„æ•°æ®ï¼Œå‹ç¼©åä¸º 2.4M å·¦å³

## ä½•æ—¶ä¸ŠæŠ¥å½•å±æ•°æ®

