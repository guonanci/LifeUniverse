抽奖或秒杀活动，同时一千个请求过来，但奖品库存只有一个，期望的结果是只有一个人中奖，剩余999个人没有中奖
但压测时，遇到的情况却是1000个都中奖了，并且库存还是一个
吓得当时脸都绿了，这是什么情况啊……
原因就是高并发时，一千个请求同时读到的库存都是一个，都中奖后，库存同时减一，最后导致库存没有减对
解决此类问题，就是要给数据库加锁的概念，保证库存一个一个减、串行的减，解决方式是使用mongoDb中update方法减库存
mongoDb中，有三种方法可以实现更新数据：
1）save方法，如db.collection.save(obj)，save是在客户端代码中生成的对象，需要从客户端回写到服务器端
2）findOneAndUpdate方法，如db.findOneAndUpdate(<filter>,{obj}), 和save类似也需要从客户端回写到服务器端
3）update方法，如db.update(<filter>,{obj})，update是服务器端处理的，速度最快；实测当并发数超过1000次每秒时，update的速度是其他的2倍


作者：海阔_天空
链接：https://juejin.cn/post/7146996646394462239
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
